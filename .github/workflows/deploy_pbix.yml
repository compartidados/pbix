name: Deploy PBIX to Power BI

on:
  push:
    branches:
      - main
    paths:
      - 'publish_pbix/**'
  workflow_dispatch:

jobs:
  Deploy-Asset:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Find PBIX files
        id: find-pbix
        run: |
          # Encontra todos os arquivos PBIX no diretório publish_pbix
          FILES=$(find publish_pbix -name "*.pbix" | tr '\n' ',')
          if [ -n "$FILES" ]; then
            # Remove a última vírgula
            FILES=${FILES%,}
            echo "files=$FILES" >> $GITHUB_OUTPUT
            echo "Arquivos encontrados: $FILES"
          else
            echo "Nenhum arquivo PBIX encontrado"
            echo "files=" >> $GITHUB_OUTPUT
          fi

      - name: Upload PBIX files
        if: steps.find-pbix.outputs.files != ''
        uses: SkyHighGrowth/gha-powerbi-utils@v1.0.1
        with:
          files: ${{ steps.find-pbix.outputs.files }}
          config_file: ".github/config/deploy_config.yaml"
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
