name: Deploy PBIX to Power BI

on:
  push:
    branches:
      - main
    paths:
      - 'publish_pbix/**'
  workflow_dispatch:

jobs:
  Deploy-Asset:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Find PBIX files
        id: find-pbix
        run: |
          # Encontrar arquivos PBIX adicionados recentemente
          FILES=$(find publish_pbix -name "*.pbix" | tr '\n' ',')
          if [ -n "$FILES" ]; then
            # Remove a última vírgula
            FILES=${FILES%,}
            echo "files=$FILES" >> $GITHUB_OUTPUT
            echo "Arquivos encontrados: $FILES"
          else
            echo "Nenhum arquivo PBIX encontrado"
            echo "files=" >> $GITHUB_OUTPUT
          fi

      - name: Create config file
        run: |
          cat > config.json << EOF
          {
            "spn_credentials": {
              "tenant_id": "eaaf39f1-6f65-42cc-bfe2-b9c336aaf2a2"
            },
            "deploy_options": {
              "max_file_size_supported_in_mb": 1000
            },
            "pbix_deploy_options": {
              "pbix_name_conflict": "CreateOrOverwrite",
              "override_model_name": true,
              "override_report_label": true
            },
            "deploy_location": {
              "workspace_id": "37ac69ab-ad7a-4540-af1d-baa525ee3c7f"
            }
          }
          EOF
          echo "Arquivo de configuração criado:"
          cat config.json

      - name: Upload PBIX files
        if: steps.find-pbix.outputs.files != ''
        uses: SkyHighGrowth/gha-powerbi-utils@v1.0.1
        with:
          files: ${{ steps.find-pbix.outputs.files }}
          args: "--config ./config.json"
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
