name: Deploy PBIX to Power BI

on:
  push:
    branches:
      - main
    paths:
      - 'publish_pbix/**'
  workflow_dispatch:

jobs:
  Deploy-Asset:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Prepare PBIX files for upload
        id: prepare-files
        run: |
          # Copia os arquivos para um diretório temporário com nomes simplificados
          mkdir -p /tmp/pbix_simple
          counter=1
          files_list=""
          
          for file in publish_pbix/*.pbix; do
            if [ -f "$file" ]; then
              # Cria um nome simplificado sem espaços ou caracteres especiais
              simple_name="file_${counter}.pbix"
              cp "$file" "/tmp/pbix_simple/$simple_name"
              
              # Adiciona à lista de arquivos
              if [ -z "$files_list" ]; then
                files_list="/tmp/pbix_simple/$simple_name"
              else
                files_list="$files_list,/tmp/pbix_simple/$simple_name"
              fi
              
              echo "Arquivo original: $file -> $simple_name"
              counter=$((counter+1))
            fi
          done
          
          echo "Arquivos preparados para upload: $files_list"
          echo "files=$files_list" >> $GITHUB_OUTPUT
          
          # Mostra os arquivos preparados
          ls -la /tmp/pbix_simple/

      - name: Create config JSON
        run: |
          cat > /tmp/config.json << EOF
          {
            "spn_credentials": {
              "tenant_id": "eaaf39f1-6f65-42cc-bfe2-b9c336aaf2a2"
            },
            "deploy_options": {
              "max_file_size_supported_in_mb": 1000
            },
            "pbix_deploy_options": {
              "pbix_name_conflict": "CreateOrOverwrite",
              "override_model_name": true,
              "override_report_label": true
            },
            "deploy_location": {
              "workspace_id": "37ac69ab-ad7a-4540-af1d-baa525ee3c7f"
            }
          }
          EOF

      - name: Upload PBIX files
        if: steps.prepare-files.outputs.files != ''
        uses: SkyHighGrowth/gha-powerbi-utils@v1.0.1
        with:
          files: ${{ steps.prepare-files.outputs.files }}
          entryPoint: python
          args: "/scripts/python/upload_file.py --config /tmp/config.json"
        env:
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
